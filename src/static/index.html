<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MosDNS Log Analysis</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/subsetted-fonts@latest/MiSans-VF/MiSans-VF.css" />
    <style>
        :root {
            --primary-color: #4361ee;
            --success-color: #2ec4b6;
            --info-color: #3a86ff;
            --background-color: #f8f9fa;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
            --hover-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'MiSans-VF', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-color);
            color: #2d3436;
        }

        .stat-card {
            padding: 25px;
            margin: 10px;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            border: none;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .stat-card.primary-card {
            background: linear-gradient(135deg, var(--primary-color), #4895ef);
        }

        .stat-card.success-card {
            background: linear-gradient(135deg, var(--success-color), #219ebc);
        }

        .stat-card.info-card {
            background: linear-gradient(135deg, var(--info-color), #48cae4);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-top: 10px;
        }

        .chart-container {
            margin: 25px 0;
            padding: 25px;
            background: white;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            box-shadow: var(--hover-shadow);
        }

        .chart-title {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eef2f7;
        }

        .table {
            margin-top: 20px;
            font-size: 14px;
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        .table thead th {
            background-color: transparent;
            border: none;
            font-weight: 600;
            color: #6c757d;
            padding: 12px;
        }

        .table tbody tr {
            background-color: white;
            box-shadow: var(--card-shadow);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .table tbody tr:hover {
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }

        .table td {
            padding: 15px;
            border: none;
            vertical-align: middle;
        }

        /* 加载动画 */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--success-color));
            animation: loading 1.5s ease-in-out infinite;
            z-index: 1000;
        }

        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* 自定义下拉框样式 */
        .custom-select {
            padding: 8px 16px;
            border-radius: 12px;
            border: 2px solid #eef2f7;
            background-color: white;
            font-size: 14px;
            font-weight: 500;
            color: #2d3436;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-select:hover {
            border-color: var(--primary-color);
        }

        /* 页面标题样式 */
        .page-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--info-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }

        /* 复制提示样式优化 */
        .copy-success {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 30px;
            background: rgba(46, 196, 182, 0.95);
            color: white;
            border-radius: 12px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(46, 196, 182, 0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .copy-success.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* IP打码相关样式 */
        .blurred-ip {
            filter: blur(4px);
            transition: filter 0.3s ease;
            padding: 4px 8px;
            background: #f8f9fa;
            border-radius: 4px;
            display: inline-block;
            user-select: none;
        }

        .blurred-ip:hover {
            filter: blur(0);
        }

        .ip-cell {
            cursor: pointer;
            position: relative;
        }

        .ip-cell:after {
            content: '点击复制';
            position: absolute;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }

        .ip-cell:hover:after {
            opacity: 1;
        }

        /* 优化下拉框样式 */
        .stats-select {
            min-width: fit-content;
            padding: 6px 32px 6px 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M2.22 4.47a.75.75 0 0 1 1.06 0L6 7.19l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L2.22 5.53a.75.75 0 0 1 0-1.06z'/%3E%3C/svg%3E") no-repeat right 12px center;
            font-size: 14px;
            color: #4a5568;
            appearance: none;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .stats-select:hover {
            border-color: var(--primary-color);
        }

        .stats-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .stats-select option {
            padding: 8px;
        }

        /* 图表容器样式调整 */
        .chart-type-container {
            width: 100%;
            max-width: 280px;
            margin: 0 auto;
            aspect-ratio: 1;
        }

        /* 调整DNS查询类型布局 */
        .query-type-stats {
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }

        .query-type-table {
            flex: 1;
            min-width: 0;  /* 防止表格溢出 */
        }

        .query-type-chart {
            flex: 0 0 auto;
            width: 320px;
        }

        @media (max-width: 768px) {
            .query-type-stats {
                flex-direction: column;
            }
            .query-type-chart {
                width: 100%;
            }
            .chart-type-container {
                max-width: 240px;
            }
        }

        /* 添加域名统计组合样式 */
        .domain-stats-container {
            min-height: 400px;
            padding: 10px;
            height: calc(100px + 30px * var(--item-count));
            transition: height 0.3s ease;
        }

        @media (max-width: 768px) {
            .domain-chart {
                min-height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- 添加加载动画 -->
    <div class="loading" id="loadingBar"></div>

    <div class="container mt-5">
        <h1 class="page-title text-center">MosDNS 日志分析</h1>
        <div class="text-center mb-4">
            <div class="text-muted">
                <span id="timeRange">统计时段: -</span>
            </div>
            <div class="text-muted mt-1">
                <small id="analysisInfo">分析耗时: -</small>
                <small class="ms-3" id="filteredInfo">已过滤域名: -</small>
            </div>
        </div>
        
        <!-- 概览统计 -->
        <div class="row">
            <div class="col-md-4">
                <div class="stat-card primary-card text-white">
                    <h5>总请求量</h5>
                    <div class="stat-number" id="totalRequests">-</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card success-card text-white">
                    <h5>缓存命中数</h5>
                    <div class="stat-number" id="cacheHits">-</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card info-card text-white">
                    <h5>缓存命中率</h5>
                    <div class="stat-number" id="hitRate">-</div>
                </div>
            </div>
        </div>

        <!-- 修改域名统计部分 -->
        <div class="chart-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="chart-title mb-0">域名请求统计</h3>
                <select class="stats-select" id="topNSelect" onchange="fetchData()">
                    <option value="10">显示前 10 名</option>
                    <option value="30">显示前 30 名</option>
                    <option value="50">显示前 50 名</option>
                    <option value="100">显示前 100 名</option>
                </select>
            </div>
            <div class="domain-stats-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- 删除原有的趋势图表容器 -->

        <!-- 添加查询类型统计 -->
        <div class="chart-container">
            <h3 class="chart-title">DNS 查询类型统计</h3>
            <div class="domain-stats-container">
                <canvas id="queryTypeChart"></canvas>
            </div>
        </div>

        <!-- 客户端请求统计 -->
        <div class="chart-container">
            <h3 class="chart-title">客户端请求统计</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>客户端 IP</th>
                        <th>请求数</th>
                        <th>位置</th>
                    </tr>
                </thead>
                <tbody id="clientStats">
                </tbody>
            </table>
        </div>
        
    </div>

    <!-- 添加复制成功提示 -->
    <div class="copy-success" id="copySuccess">已复制到剪贴板</div>

    <script>
        async function getIpLocation(ip) {
            try {
                const response = await fetch(`https://api.ip.sb/geoip/${ip}`);
                if (response.ok) {
                    const data = await response.json();
                    const location = [
                        data.country || '未知',
                        data.region || '', 
                        data.isp || ''
                    ].filter(Boolean).join(' | ');
                    return location;
                }
            } catch (error) {
                console.error(`Error fetching location for IP ${ip}:`, error);
            }
            return '未知';
        }

        // 复制IP地址到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess();
            }).catch(err => {
                console.error('复制失败:', err);
            });
        }

        // 更新客户端统计表格
        async function updateClientStats(clients) {
            const clientTbody = document.getElementById('clientStats');
            clientTbody.innerHTML = '';
            
            for (const client of clients) {
                clientTbody.innerHTML += `
                    <tr>
                        <td class="ip-cell">
                            <code class="blurred-ip" onclick="copyToClipboard('${client.ip}')">${client.ip}</code>
                        </td>
                        <td>${client.requests}</td>
                        <td><small>${client.location}</small></td>
                    </tr>
                `;
            }
        }

        // 显示/隐藏加载动画
        function toggleLoading(show) {
            document.getElementById('loadingBar').style.display = show ? 'block' : 'none';
        }

        // 从后端获取数据并更新页面
        async function fetchData() {
            toggleLoading(true);
            try {
                const topN = document.getElementById('topNSelect').value;
                const response = await fetch(`http://localhost:8000/stats?limit=${topN}`);
                const data = await response.json();
                
                // 更新时间信息
                if (data.time_range) {
                    document.getElementById('timeRange').textContent = 
                        `统计时段: ${data.time_range.start} 至 ${data.time_range.end}`;
                }
                if (data.analysis_info) {
                    document.getElementById('analysisInfo').textContent = 
                        `分析耗时: ${data.analysis_info.duration}`;
                }
                
                // 更新概览统计
                document.getElementById('totalRequests').textContent = data.total_requests;
                document.getElementById('cacheHits').textContent = data.cache_hits;
                document.getElementById('hitRate').textContent = data.hit_rate + '%';

                // 更新已过滤数量 - 只显示过滤的域名数量
                if (data.blacklist_stats) {
                    document.getElementById('filteredInfo').textContent = 
                        `已过滤域名: ${data.blacklist_stats.unique_blocked_domains}个`;
                }

                // 更新趋势图表 - 修正数据显示
                const ctx = document.getElementById('trendChart').getContext('2d');
                
                // 销毁现有图表以避免重叠
                if (window.domainChart) {
                    window.domainChart.destroy();
                }

                // 在更新图表数据之前设置容器高度
                const container = document.querySelector('.domain-stats-container');
                container.style.setProperty('--item-count', data.top_domains.length);

                window.domainChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.top_domains.map(domain => domain.domain),
                        datasets: [{
                            label: '未命中',
                            data: data.top_domains.map(domain => domain.requests - domain.cache_hits),
                            backgroundColor: function(context) {
                                const chart = context.chart;
                                const {ctx, chartArea} = chart;
                                if (!chartArea) {
                                    return 'rgba(37, 99, 235, 0.9)';
                                }
                                let gradientFill = ctx.createLinearGradient(0, 0, chartArea.width, 0);
                                gradientFill.addColorStop(0, 'rgba(37, 99, 235, 0.9)');
                                gradientFill.addColorStop(1, 'rgba(59, 130, 246, 0.9)');
                                return gradientFill;
                            },
                            borderWidth: 0,
                            borderRadius: 5,
                            barPercentage: 0.95,
                            categoryPercentage: 0.9
                        }, {
                            label: '缓存命中',
                            data: data.top_domains.map(domain => domain.cache_hits),
                            backgroundColor: function(context) {
                                const chart = context.chart;
                                const {ctx, chartArea} = chart;
                                if (!chartArea) {
                                    return 'rgba(46, 196, 182, 0.8)';
                                }
                                let gradientFill = ctx.createLinearGradient(0, 0, chartArea.width, 0);
                                gradientFill.addColorStop(0, 'rgba(46, 196, 182, 0.9)');
                                gradientFill.addColorStop(1, 'rgba(33, 158, 188, 0.9)');
                                return gradientFill;
                            },
                            borderWidth: 0,
                            borderRadius: 5,
                            barPercentage: 0.95,
                            categoryPercentage: 0.9
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 300,
                            easing: 'easeOutQuart'
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                align: 'end',
                                labels: {
                                    boxWidth: 12,
                                    usePointStyle: true,
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                enabled: true,
                                mode: 'nearest',
                                intersect: true,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                bodySpacing: 4,
                                position: 'nearest',  // 改为nearest
                                events: ['mousemove'],
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const item = tooltipItems[0];
                                        // 未命中时只显示域名
                                        if (item.datasetIndex === 0) {
                                            return item.label;
                                        }
                                        return item.label;
                                    },
                                    label: function(tooltipItem) {
                                        const value = tooltipItem.raw;
                                        if (tooltipItem.datasetIndex === 0) {
                                            return [`未命中: ${value}次`];
                                        }
                                        
                                        const domain = tooltipItem.label;
                                        const domainData = data.top_domains.find(d => d.domain === domain);
                                        if (!domainData || !domainData.details) return '';
                                        
                                        let lines = [
                                            `总请求数: ${domainData.requests}`,
                                            `缓存命中: ${domainData.cache_hits}`,
                                            `命中率: ${((domainData.cache_hits / domainData.requests) * 100).toFixed(1)}%`,
                                            ''
                                        ];
                                        
                                        // ...existing tooltip code...
                                        
                                        return lines;
                                    },
                                    labelColor: function(tooltipItem) {
                                        // 返回对应数据集的颜色
                                        const dataset = tooltipItem.dataset;
                                        const color = tooltipItem.datasetIndex === 0 ? 
                                            'rgba(37, 99, 235, 0.9)' : 
                                            'rgba(46, 196, 182, 0.9)';
                                        return {
                                            borderColor: color,
                                            backgroundColor: color
                                        };
                                    }
                                }
                            },
                            datalabels: {  // 添加数值标签
                                color: '#2c3e50',
                                font: {
                                    weight: '600',
                                    size: 11
                                },
                                anchor: 'end',
                                align: 'start',
                                formatter: (value, context) => {
                                    return value;  // 直接显示数值
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,  // 启用堆叠
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    precision: 0
                                }
                            },
                            y: {
                                stacked: true,  // 启用堆叠
                                grid: {
                                    borderDash: [2, 4]
                                },
                                ticks: {
                                    padding: 10,
                                    callback: function(value) {
                                        const label = this.getLabelForValue(value);
                                        // 如果标签太长，截断并添加省略号
                                        return label.length > 30 ? label.slice(0, 27) + '...' : label;
                                    }
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'customBarText',
                        afterDraw: function(chart) {
                            const ctx = chart.ctx;
                            const activeElements = chart.getActiveElements();
                            
                            chart.data.datasets.forEach((dataset, i) => {
                                const meta = chart.getDatasetMeta(i);
                                meta.data.forEach((bar, index) => {
                                    const value = dataset.data[index];
                                    if (value > 0) {
                                        const position = bar.tooltipPosition();
                                        const barWidth = bar.width;
                                        
                                        // 检查当前条形图是否被hover
                                        const isBarHovered = activeElements.some(element => 
                                            element.datasetIndex === i && element.index === index
                                        );
                                        
                                        // 如果当前条不是被hover的，就显示数字
                                        if (!isBarHovered) {
                                            ctx.save();
                                            ctx.fillStyle = '#FFFFFF';
                                            ctx.font = '500 11px MiSans-VF';
                                            ctx.textAlign = 'left';
                                            ctx.textBaseline = 'middle';
                                            
                                            const text = value.toString();
                                            const textWidth = ctx.measureText(text).width;
                                            const minWidthForText = textWidth + 10;
                                            
                                            if (barWidth > minWidthForText) {
                                                const padding = 5;
                                                const x = position.x - textWidth - padding;
                                                const y = position.y;
                                                ctx.fillText(text, x, y);
                                            }
                                            ctx.restore();
                                        }
                                    }
                                });
                            });
                        }
                    }]
                });

                // 修改查询类型统计图表初始化
                const typeCtx = document.getElementById('queryTypeChart').getContext('2d');
                
                // 销毁现有图表以避免重叠
                if (window.queryTypeChart instanceof Chart) {
                    window.queryTypeChart.destroy();
                }
                
                // 调整容器高度
                const typeContainer = typeCtx.canvas.closest('.domain-stats-container');
                typeContainer.style.setProperty('--item-count', data.query_types.length);

                window.queryTypeChart = new Chart(typeCtx, {
                    type: 'bar',
                    data: {
                        labels: data.query_types.map(t => t.type),
                        datasets: [{
                            label: '请求数',
                            data: data.query_types.map(t => t.count),
                            backgroundColor: 'rgba(67, 97, 238, 0.8)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 200
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                callbacks: {
                                    label: function(context) {
                                        return `请求数: ${context.raw}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    precision: 0
                                }
                            },
                            y: {
                                grid: {
                                    borderDash: [2, 4]
                                },
                                ticks: {
                                    padding: 10
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'customBarText',
                        afterDraw: function(chart) {
                            const ctx = chart.ctx;
                            const activeElements = chart.getActiveElements();
                            
                            chart.data.datasets.forEach((dataset, i) => {
                                const meta = chart.getDatasetMeta(i);
                                meta.data.forEach((bar, index) => {
                                    const value = dataset.data[index];
                                    if (value > 0) {
                                        const position = bar.tooltipPosition();
                                        const barWidth = bar.width;
                                        
                                        // 检查当前条形图是否被hover
                                        const isBarHovered = activeElements.some(element => 
                                            element.datasetIndex === i && element.index === index
                                        );
                                        
                                        // 如果当前条不是被hover的，就显示数字
                                        if (!isBarHovered) {
                                            ctx.save();
                                            ctx.fillStyle = '#FFFFFF';
                                            ctx.font = '500 11px MiSans-VF';
                                            ctx.textAlign = 'left';
                                            ctx.textBaseline = 'middle';
                                            
                                            const text = value.toString();
                                            const textWidth = ctx.measureText(text).width;
                                            const minWidthForText = textWidth + 10;
                                            
                                            if (barWidth > minWidthForText) {
                                                const padding = 5;
                                                const x = position.x - textWidth - padding;
                                                const y = position.y;
                                                ctx.fillText(text, x, y);
                                            }
                                            ctx.restore();
                                        }
                                    }
                                });
                            });
                        }
                    }]
                });

                // 更新客户端统计
                const clients = data.top_clients || [];
                await updateClientStats(clients);

            } catch (error) {
                console.error('Error fetching data:', error);
            } finally {
                toggleLoading(false);
            }
        }

        // 改进WebSocket连接处理
        let ws;
        function connectWebSocket() {
            ws = new WebSocket('ws://' + window.location.host + '/ws');
            ws.onmessage = function(event) {
                if(event.data === 'update') {
                    fetchData();
                }
            };
            ws.onclose = function() {
                // 连接关闭后自动重连
                setTimeout(connectWebSocket, 1000);
            };
        }
        
        // 取消定时刷新，改用WebSocket
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            connectWebSocket();
        });

        // 改进的复制提示函数
        function showCopySuccess() {
            const toast = document.getElementById('copySuccess');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
    </script>
</body>
</html>